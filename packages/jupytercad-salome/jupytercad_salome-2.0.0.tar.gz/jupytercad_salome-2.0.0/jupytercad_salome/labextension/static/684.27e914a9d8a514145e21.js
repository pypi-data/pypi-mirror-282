(self.webpackChunk_jupytercad_jupytercad_salome=self.webpackChunk_jupytercad_jupytercad_salome||[]).push([[684],{684:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>I});var s=r(18),n=r(660),o=r(953),a=r(456);class i{constructor(e){this.config=e}}var c=r(450),l=r.n(c),d=r(230),u=r.n(d);class h extends Error{constructor(e,t,r){super(r),this.name="ApiError",this.url=t.url,this.status=t.status,this.statusText=t.statusText,this.body=t.body,this.request=e}}class p extends Error{constructor(e){super(e),this.name="CancelError"}get isCancelled(){return!0}}class m{constructor(e){this._isResolved=!1,this._isRejected=!1,this._isCancelled=!1,this._cancelHandlers=[],this._promise=new Promise(((t,r)=>{this._resolve=t,this._reject=r;const s=e=>{this._isResolved||this._isRejected||this._isCancelled||this._cancelHandlers.push(e)};return Object.defineProperty(s,"isResolved",{get:()=>this._isResolved}),Object.defineProperty(s,"isRejected",{get:()=>this._isRejected}),Object.defineProperty(s,"isCancelled",{get:()=>this._isCancelled}),e((e=>{var t;this._isResolved||this._isRejected||this._isCancelled||(this._isResolved=!0,null===(t=this._resolve)||void 0===t||t.call(this,e))}),(e=>{var t;this._isResolved||this._isRejected||this._isCancelled||(this._isRejected=!0,null===(t=this._reject)||void 0===t||t.call(this,e))}),s)}))}then(e,t){return this._promise.then(e,t)}catch(e){return this._promise.catch(e)}finally(e){return this._promise.finally(e)}cancel(){var e;if(!(this._isResolved||this._isRejected||this._isCancelled)){if(this._isCancelled=!0,this._cancelHandlers.length)try{for(const e of this._cancelHandlers)e()}catch(e){return void console.warn("Cancellation threw an error",e)}this._cancelHandlers.length=0,null===(e=this._reject)||void 0===e||e.call(this,new p("Request aborted"))}}get isCancelled(){return this._isCancelled}}Symbol.toStringTag;const y=e=>null!=e,v=e=>"string"==typeof e,f=e=>v(e)&&""!==e,g=e=>"object"==typeof e&&"string"==typeof e.type&&"function"==typeof e.stream&&"function"==typeof e.arrayBuffer&&"function"==typeof e.constructor&&"string"==typeof e.constructor.name&&/^(Blob|File)$/.test(e.constructor.name)&&/^(Blob|File)$/.test(e[Symbol.toStringTag]),b=async(e,t)=>"function"==typeof t?t(e):t,S=async(e,t,r)=>{const s=await b(t,e.TOKEN),n=await b(t,e.USERNAME),o=await b(t,e.PASSWORD),a=await b(t,e.HEADERS),i="function"==typeof(null==r?void 0:r.getHeaders)&&(null==r?void 0:r.getHeaders())||{},c=Object.entries({Accept:"application/json",...a,...t.headers,...i}).filter((([e,t])=>y(t))).reduce(((e,[t,r])=>({...e,[t]:String(r)})),{});if(f(s)&&(c.Authorization=`Bearer ${s}`),f(n)&&f(o)){const e=(e=>{try{return btoa(e)}catch(t){return Buffer.from(e).toString("base64")}})(`${n}:${o}`);c.Authorization=`Basic ${e}`}return t.body&&(t.mediaType?c["Content-Type"]=t.mediaType:g(t.body)?c["Content-Type"]=t.body.type||"application/octet-stream":v(t.body)?c["Content-Type"]="text/plain":t.body instanceof u()||(c["Content-Type"]="application/json")),c},E=(e,t)=>new m((async(r,s,n)=>{try{const s=((e,t)=>{const r=e.ENCODE_PATH||encodeURI,s=t.url.replace("{api-version}",e.VERSION).replace(/{(.*?)}/g,((e,s)=>{var n;return(null===(n=t.path)||void 0===n?void 0:n.hasOwnProperty(s))?r(String(t.path[s])):e})),n=`${e.BASE}${s}`;return t.query?`${n}${(e=>{const t=[],r=(e,s)=>{y(s)&&(Array.isArray(s)?s.forEach((t=>{r(e,t)})):"object"==typeof s?Object.entries(s).forEach((([t,s])=>{r(`${e}[${t}]`,s)})):((e,r)=>{t.push(`${encodeURIComponent(e)}=${encodeURIComponent(String(r))}`)})(e,s))};return Object.entries(e).forEach((([e,t])=>{r(e,t)})),t.length>0?`?${t.join("&")}`:""})(t.query)}`:n})(e,t),a=(e=>{if(e.formData){const t=new(u()),r=(e,r)=>{v(r)||g(r)?t.append(e,r):t.append(e,JSON.stringify(r))};return Object.entries(e.formData).filter((([e,t])=>y(t))).forEach((([e,t])=>{Array.isArray(t)?t.forEach((t=>r(e,t))):r(e,t)})),t}})(t),i=(e=>{if(e.body)return e.body})(t),c=await S(e,t,a);if(!n.isCancelled){const d=await(async(e,t,r,s,n,o,a)=>{const i=l().CancelToken.source(),c={url:r,headers:o,data:null!=s?s:n,method:t.method,withCredentials:e.WITH_CREDENTIALS,cancelToken:i.token};a((()=>i.cancel("The user aborted a request.")));try{return await l().request(c)}catch(e){const t=e;if(t.response)return t.response;throw e}})(e,t,s,i,a,c,n),u=(e=>{if(204!==e.status)return e.data})(d),p=((e,t)=>{if(t){const r=e.headers[t];if(v(r))return r}})(d,t.responseHeader),m={url:s,ok:(o=d.status,o>=200&&o<300),status:d.status,statusText:d.statusText,body:null!=p?p:u};((e,t)=>{const r={400:"Bad Request",401:"Unauthorized",403:"Forbidden",404:"Not Found",500:"Internal Server Error",502:"Bad Gateway",503:"Service Unavailable",...e.errors}[t.status];if(r)throw new h(e,t,r);if(!t.ok)throw new h(e,t,"Generic Error")})(t,m),r(m.body)}}catch(e){s(e)}var o}));class _ extends i{constructor(e){super(e)}request(e){return E(this.config,e)}}class j{constructor(e){this.httpRequest=e}generateMesh({requestBody:e}){return this.httpRequest.request({method:"POST",url:"/jupytercad-salome/execute",body:e,mediaType:"application/json",errors:{405:"Invalid input"}})}}class w{constructor(e,t=_){var r,s,n,o;this.request=new t({BASE:null!==(r=null==e?void 0:e.BASE)&&void 0!==r?r:"",VERSION:null!==(s=null==e?void 0:e.VERSION)&&void 0!==s?s:"1.0.0",WITH_CREDENTIALS:null!==(n=null==e?void 0:e.WITH_CREDENTIALS)&&void 0!==n&&n,CREDENTIALS:null!==(o=null==e?void 0:e.CREDENTIALS)&&void 0!==o?o:"include",TOKEN:null==e?void 0:e.TOKEN,USERNAME:null==e?void 0:e.USERNAME,PASSWORD:null==e?void 0:e.PASSWORD,HEADERS:null==e?void 0:e.HEADERS,ENCODE_PATH:null==e?void 0:e.ENCODE_PATH}),this.execute=new j(this.request)}}var C=r(369),R=r(72);const O=new(r(45).LabIcon)({name:"jupytercad:grid-icon",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24">\n  <g class="jp-icon3" fill="#616161">\n    <path\n      d="M120-520v-320h320v320H120Zm0 400v-320h320v320H120Zm400-400v-320h320v320H520Zm0 400v-320h320v320H520ZM200-600h160v-160H200v160Zm400 0h160v-160H600v160Zm0 400h160v-160H600v160Zm-400 0h160v-160H200v160Zm400-400Zm0 240Zm-240 0Zm0-240Z" />\n  </g>\n</svg>\n'}),T=JSON.parse('{"type":"object","required":["Object"],"additionalProperties":false,"properties":{"Object":{"type":"string","description":"The name of input object"},"NumberOfSegments":{"type":"number","description":"The number of segments"}}}');var N,k=r(930),A=r(231);!function(e){let t;!function(e){e.BREP="brep",e.STEP="step"}(t=e.format||(e.format={}))}(N||(N={}));const x="jupytercad-salome-worker";class H{constructor(e){this.shapeFormat=s.JCadWorkerSupportedFormat.BREP,this._ready=new k.PromiseDelegate,this._messageHandlers=new Map,this._appClient=e.appClient,this._tracker=e.tracker}get ready(){return this._ready.promise}register(e){const{messageHandler:t,thisArg:r}=e,s=(0,A.v4)();return r&&t.bind(r),this._messageHandlers.set(s,t),s}unregister(e){this._messageHandlers.delete(e)}postMessage(e){var t,r,n;if(e.action===s.WorkerAction.POSTPROCESS&&e.payload){const{jcObject:o,postShape:a}=e.payload;if(!a)return;const i=null!==(r=null===(t=null==o?void 0:o.parameters)||void 0===t?void 0:t.NumberOfSegments)&&void 0!==r?r:15;this._appClient.execute.generateMesh({requestBody:{sourcePath:null===(n=this._tracker.currentWidget)||void 0===n?void 0:n.context.path,geometry:a,format:N.format.BREP,numberOfSegments:i}}).then((t=>{const r=e.id,n=[];if(t.error?(0,R.showErrorMessage)("Execution Error",t.error):n.push({postResult:{format:"STL",binary:!0,value:t.mesh},jcObject:o}),n.length>0){const e=this._messageHandlers.get(r);e&&e({action:s.MainAction.DISPLAY_POST,payload:n})}}))}}}var P,D;!function(e){e.mesh="jupytercad:salome:mesh"}(P||(P={})),function(e){const t=e=>{var t,r,s;const n=e.getAllObject(),o=null===(r=null===(t=e.localState)||void 0===t?void 0:t.selected)||void 0===r?void 0:r.value;let a=null!==(s=n[0].name)&&void 0!==s?s:"";if(o)for(const e in o)if("shape"===o[e].type){a=e;break}return{Name:(0,C.newName)("Mesh",e),Object:a,NumberOfSegments:10}};e.executeMeshOperatorFactory=function(e){return async r=>{const n=e.currentWidget;if(!n)return;const o=JSON.parse(JSON.stringify(T));o.required=["Name",...o.required],o.properties={Name:{type:"string",description:"The Name of the Object"},...o.properties};const{...a}=o,i=new C.FormDialog({context:n.context,title:"Mesh parameters",sourceData:t(n.context.model),schema:a,syncData:(c=n.context.model,e=>{const{Name:t,...r}=e,n={shape:"Post::SalomeMesh",parameters:r,visible:!0,name:t,shapeMetadata:{shapeFormat:s.JCadWorkerSupportedFormat.BREP,workerId:x}},o=c.sharedModel;o&&o.transact((()=>{r.Object.length>0&&(0,C.setVisible)(o,r.Object,!1),o.objectExists(n.name)?(0,R.showErrorMessage)("The object already exists","There is an existing object with the same name."):o.addObject(n)}))}),cancelButton:!0});var c;await i.launch()}}}(D||(D={}));const I=[{id:"jupytercad-salome:plugin",description:"JupyterCad Salome plugin.",autoStart:!0,requires:[s.IJCadWorkerRegistryToken,s.IJCadFormSchemaRegistryToken,s.IJupyterCadDocTracker,s.IJCadExternalCommandRegistryToken],optional:[a.ITranslator],activate:async(e,t,r,s,i,c)=>{console.log("jupytercad:salome is activated!"),c=null!=c?c:a.nullTranslator;const l=o.ServerConnection.makeSettings(),d=n.URLExt.join("jupytercad-salome","get-backend"),u=await async function(e="",t={}){const r=o.ServerConnection.makeSettings(),s=n.URLExt.join(r.baseUrl,e);let a;try{a=await o.ServerConnection.makeRequest(s,t,r)}catch(e){throw new o.ServerConnection.NetworkError(e)}let i=await a.text();if(i.length>0)try{i=JSON.parse(i)}catch(e){console.log("Not a JSON response body.",a)}if(!a.ok)throw new o.ServerConnection.ResponseError(a,i.message||i);return i}(d);let h="";h=u.backend_url?u.backend_url:l.baseUrl.replace(/\/$/,"");const p=new w({BASE:h,TOKEN:l.token}),m=new H({appClient:p,tracker:s});t.registerWorker(x,m),r.registerSchema("Post::SalomeMesh",T),function(e,t,r){const s=r.load("jupyterlab"),{commands:n}=e;n.addCommand(P.mesh,{label:s.__("Mesh creation"),isEnabled:()=>Boolean(t.currentWidget),icon:O,execute:D.executeMeshOperatorFactory(t)})}(e,s,c),i.registerCommand({name:"Mesh Creation",id:P.mesh})}}]},230:e=>{e.exports="object"==typeof self?self.FormData:window.FormData}}]);