[build-system]
requires = ["poetry-core>=1.2.0"]
build-backend = "poetry.core.masonry.api"

[tool.poetry]
name = "eta-utility"
version = "v3.2.0"
description = "A framework for researching energy optimization of factory operations"
authors = [
    "Technical University of Darmstadt, Institute for Production Management, Technology and Machine Tools (PTW). <info@ptw.tu-darmstadt.de>"
]
readme = "README.rst"
license = "BSD-2-Clause"

keywords = [
    "connectors","servers","simulators","industrial energy optimization","rolling horizon optimization"
]
include = [
    {path = "*", format="sdist"}, # include all package data (for sdist)
]
classifiers = [
    "License :: OSI Approved :: BSD License",
    "Development Status :: 4 - Beta",
    "Intended Audience :: Developers",
    "Intended Audience :: Science/Research",
    "Intended Audience :: Manufacturing",
    "Topic :: Scientific/Engineering :: Artificial Intelligence",
    "Topic :: Software Development :: Libraries",
    "Operating System :: OS Independent",
    "Programming Language :: Python :: 3 :: Only",
]

homepage = "https://www.ptw.tu-darmstadt.de"
documentation = "https://eta-utility.readthedocs.io/"
repository = "https://github.com/PTW-TUDa/eta_utility/"

[tool.poetry.urls]
"Issues" = "https://git.ptw.maschinenbau.tu-darmstadt.de/eta-fabrik/public/eta-utility/-/issues"

[tool.poetry.scripts]
    install-julia = "eta_utility:install_julia"
    update-julia-agent = "eta_utility:update_agent"

#  '^' limits to the next major version, '~' limits to the next minor version
# e.g. ^3.9.0: 3.9.0 <= x < 4.0.0 and ~3.9.0: 3.9.0 <= x < 3.10.0
[tool.poetry.dependencies]
# default dependencies of eta_utility
python = ">=3.9, <3.12"
attrs = "^23.1.0"
python-dateutil = "^2.8.2"
numpy = {version= "~1.26.0"}
pandas = {version= "~2.2.2"}
xlrd = "^2.0.1"
asyncua-fork-for-eta-utility = "==1.0.7"
lxml = "^4.9.3"
requests = "^2.31.0"
pymodbustcp = "==0.2.0"
cryptography = "^41.0.4"
wetterdienst = {version="~0.82.0", python="^3.9"}  # breaking changes expected
requests-cache = "^1.2.0"
fmpy = "0.3.19"


# Specific requirements for eta_x
gymnasium =  {version = "==0.29.1", optional=true} # no SemVer
stable-baselines3 = {version = "==2.2.1", optional=true} # no SemVer
tensorboard = {version = "~2.14.0", optional=true}
pyomo = {version = "~6.6.2", optional=true}

# Specific requirements for the examples
matplotlib = {version= "~3.7.0", optional = true}
keyboard = {version="^0.13.5", optional=true}
pygame = {version="^2.5.2", optional=true}
pyglet = {version="<2", optional=true}
onnxruntime = {version="^1.16.0", optional=true}

# Specific requirements for tests
pytest = {version = "^7.4.2", optional = true}
pytest-cov = {version = "^4.1.0", optional = true}
openpyxl = {version = "^3.1.2", optional = true}
# Specific requirements for development
sphinx = {version ="^7.1.2", optional = true}
sphinx-rtd-theme = {version = "^1.3.0", optional = true}
sphinx-copybutton = {version = "^0.5.2", optional = true}
pre-commit = {version = "^3.4.0", optional = true}
black = {version = "~23.7", optional = true}
blacken_docs = {version = "~1.16", optional = true}
# MyPy requirements and typing packages
mypy = {version = "~1.9", optional = true}
types-python-dateutil = {version = "^2.8.19.14", optional = true}
types-requests = {version = "^2.31.0.4", optional = true}
types-pytz = {version = "^2024.1.0.20240203", optional = true}
# Ruff
ruff = {version = "~0.4.4", optional = true}
torch = {version = "2.0.0", source = "pytorch_cpu"}


[tool.poetry.extras]
develop = ["gymnasium", "torch", "stable_baselines3", "tensorboard", "pyomo",     # include eta_x
            "matplotlib", "keyboard", "pygame", "pyglet", "onnxruntime",    # include examples
            "pytest", "pytest-cov", "openpyxl", "sphinx", "sphinx-rtd-theme", "sphinx-copybutton", "pre-commit",
            "black", "blacken_docs", "mypy", "types-python-dateutil",
            "types-requests", "types-pytz", "ruff"]
eta_x = ["gymnasium", "torch", "stable_baselines3", "tensorboard", "pyomo"]
examples = ["matplotlib", "keyboard", "pygame", "pyglet", "onnxruntime"]



[[tool.poetry.source]]
name = "pytorch_cpu"
url = "https://download.pytorch.org/whl/cpu"
priority = "explicit"

[tool.black]
include = "\\.pyi?$|^eta_utility/|^test/"
exclude = "\\.xlsx?$|\\.fmu?$|test_resources/|__pycache__/|_version.py|.venv/$"
line_length = 120
target_version = ["py39","py310", "py311"]


[tool.mypy]
python_version = "3.9"
files = ["eta_utility", "examples"]
disallow_untyped_defs = true
disallow_incomplete_defs = true
no_implicit_optional = true
warn_unused_ignores = true
warn_unreachable = true
show_column_numbers = true

exclude = [
    "docs/conf.py",
    "^test/",
]

[[tool.mypy.overrides]]
module = [
    "fmpy.*",
    "pandas.*",
    "gymnasium.*",
    "opcua.*",
    "pyModbusTCP.*",
    "pyomo.*",
    "lxml.*",
    "julia.*",
    "setuptools",
    "importlib.metadata.*",
    "keyboard.*",
    "onnxruntime.*",
    "matplotlib.*",
    "torch.*",
    "asyncua.*",
    "wetterdienst.*",
    "requests_cache.*",
]
ignore_missing_imports = true
[[tool.mypy.overrides]]
module = "test.*"
ignore_errors = true

[tool.pytest.ini_options]
addopts = "--cov-config=pyproject.toml"
log_cli = true
testpaths = [
    "test",
]

# Configuration for pytest-cov
[tool.coverage.run]
source = [
    "eta_utility"
]
omit = [
    "*/venv/*",
    "*/.venv/*",
    "*/docs/*",
    "*/build/*",
    "*/dist/*",
    "*/eta_utility/type_hints/*",
]

[tool.coverage.report]
exclude_lines = [
    # These lines are excluded from coverage because they are not meant to be tested
    'pragma: no cover',
    'if TYPE_CHECKING:',
    'raise NotImplementedError',
    'pass',
]

[tool.ruff]
include = ["pyproject.toml", "eta_utility/**/*.py", "test/**/*.py", "examples/**/*.py"]

line-length = 120
indent-width = 4

required-version = ">=0.4.0"
target-version= "py39"

# Only fix with $ruff check --fix
fix = false

[tool.ruff.lint]
select = [
    "F",       # Pyflakes
    "E", "W",  # Pycodestyle, Error and Warning
    "I",       # Isort
    "N",       # Pep8-naming conventions
    "UP",      # Pyupgrade
    "PL",      # Pylint
    "RUF",     # Ruff
    "NPY",     # NumPy-specific

    # Flake8:
    # asyncio, commas, comprehensions, eradicate, future-annotations,
    # logging, no-pep420, print, pytest-style, simplify
    "ASYNC","COM", "C4", "ERA", "FA", "LOG", "INP", "T20", "PT", "SIM",

    ]

ignore = [
    "SIM105",
    "PLR2004",  # Pylint: magic values
    # Recommended to ignore as they conflict with the formatter
    "W191", "E111", "E114", "E117", "D206", "D300", "COM812", "COM819",
]


[tool.ruff.lint.extend-per-file-ignores]
"__init__.py" = ["PLC0414"]
"test/*" = ["RUF012"]

[tool.ruff.lint.isort]
combine-as-imports = true
force-wrap-aliases = true

[tool.ruff.lint.pylint]
max-args = 17
max-branches = 24
max-statements = 64
max-returns = 9
